graph LR
    subgraph "ğŸ¦ Data Preservation Strategy"
        A[Incoming Polar Data] --> B{Existing Subscription?}
        
        B -->|Found| C[ğŸ“¦ Base Data<br/>- userId<br/>- polarCustomerId<br/>- polarSubscriptionId<br/>- status<br/>- currentPeriodEnd<br/>- etc.]
        
        C --> D[ğŸ’° Credits Fallback Chain]
        D --> E["creditsGrantPerPeriod:<br/>args â†’ existing polar â†’ existing user â†’ DEFAULT_GRANT"]
        D --> F["creditsRolloverLimit:<br/>args â†’ existing polar â†’ existing user â†’ DEFAULT_ROLLOVER_LIMIT"]
        
        B -->|Found| G[ğŸ’¾ Preserved Data]
        G --> H["creditsBalance:<br/>NEVER lost - preserves user's money"]
        G --> I["lastGrantCursor:<br/>Prevents duplicate credit grants"]
        
        C --> J[ğŸ”§ Final Update]
        H --> J
        I --> J
        E --> J
        F --> J
        
        J --> K[âœ… User keeps all credits<br/>Even if Polar ID changes!]
    end
    
    subgraph "ğŸš¨ What We Prevent"
        L[âŒ Credit Loss] 
        M[âŒ Duplicate Grants]
        N[âŒ Subscription Hijacking]
        O[âŒ Data Corruption]
    end
    
    style A fill:#e3f2fd
    style K fill:#c8e6c9
    style L fill:#ffebee
    style M fill:#ffebee
    style N fill:#ffebee
    style O fill:#ffebee